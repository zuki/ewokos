# aarch64版 2025/10/19現在のmasterのビルド

## toolchain

```bash
$ aarch64-none-elf-gcc --version
aarch64-none-elf-gcc (Arm GNU Toolchain 14.3.Rel1 (Build arm-14.174)) 14.3.1 20250623
```

## raspixの導入

- raspix関係のソースはmachine.3rdで別リポジトリで管理されるようになった。

```bash
$ git submodule update --init --recursive
```

## make

```bash
$ export ARCH=aarch64
$ machine.3rd/raspix/kernel
$ make
$ cd ../system
$ make basic
$ make sd
...
make: mke2fs: No such file or directory
make: *** [Makefile:77: sd] Error 127
$ echo 'export PATH="/opt/homebrew/opt/e2fsprogs/sbin:$PATH"' >> /Users/zuki/.bash_profile
$ which mke2fs
/opt/homebrew/opt/e2fsprogs/sbin/mke2fs
$ make sd
$ ls
bin			etc			root_aarch64.ext2
build			libs
drivers			Makefile
$ cd ../kernel
$ make run
qemu-system-aarch64 -M raspi3b -serial null -serial mon:stdio -kernel kernel8.img -sd ../system/root_aarch64.ext2
WARNING: Image format was not specified for '../system/root_aarch64.ext2' and probing guessed raw.
         Automatically detecting the format is dangerous for raw images, write operations on block 0 will be restricted.
         Specify the 'raw' format explicitly to remove the restrictions.

=== ewokos booting ===

kernel: init kernel malloc     ... [OK]
kernel: init sd                ... [OK]
kernel: load kernel config     ... [OK]
kernel: remapping kernel mem   ... [OK]
-----------------------------------------------------
 ______           ______  _    _   ______  ______ 
(  ___ \|\     /|(  __  )| \  / \ (  __  )(  ___ \
| (__   | | _ | || |  | || (_/  / | |  | || (____
|  __)  | |( )| || |  | ||  _  (  | |  | |(____  )
| (___  | || || || |__| || ( \  \ | |__| |  ___) |
(______/(_______)(______)|_/  \_/ (______)\______)

  machine              raspberry-pi3b
  arch                 aarch64
  cores                4
  kernel_timer_freq    1024
  mem_offset           0x00000000
  phy mem size         1024 MB
  usable mem size      1024 MB
  kmalloc              0x004f5000 ~ 0x00cf5000 (8 MB)
  allocable mem info   0x02cf5000 ~ 0x3c000000 (917 MB)
  mmio_base            Phy:0x3f000000, V: 0xe8000000 (31 MB)
  sys_dma_base         Phy:0x01cf5000, V: 0xf0000000 (16384 KB)
  framebuffer_base     V: 0xf1000000 (64 MB)
  max proc num         128
  max task total       512
  max task per proc    64
-----------------------------------------------------
kernel: init kernel event      ... [OK]
kernel: loading init ... [ok]
kernel: start cores ... 0 1 2 3

[init process started]
init: /sbin/core         [ok]
init: /sbin/vfsd         [ok]
init: /sbin/sdfsd        [ok]
dev: /drivers/timerd [OK]
dev: /drivers/ramfsd [OK]
dev: /drivers/nulld [OK]
run: /sbin/sessiond [OK]
run: /bin/session [OK]

+-----Ewok micro-kernel OS-----------------------+
| https://github.com/MisaZhu/EwokOS.git          |
+------------------------------------------------+
[/dev/tty0] login: root
[/dev/tty0] password: ****
[/dev/tty0]:/# ls
    12k [lost+found]
     1k [drivers]
     1k [bin]
     1k [sbin]
     1k [etc]
     1k [dev]
     1k [tmp]
[/dev/tty0]:/# ls sbin
   585k sessiond
   683k init
   475k core
   589k vfsd
   579k telnetd
   649k httpd
   687k sdfsd
[/dev/tty0]:/# ls bin
   609k cat
   559k mkfifo
   561k svcinfo
   578k md5
   510k splash
   649k dump
   476k echo
   574k ipcserv
   469k pwd
   794k test
   565k whoami
   467k sleep
   701k shell
   573k setux
   564k uname
   575k aplay
   581k mmio
   583k tsaver
   469k elfinfo
   469k grep
   610k more
   514k head
   567k clear
   567k kill
   683k ps
   585k json
   574k bgrun
   936k bt
   661k devcmd
   559k mkdir
   559k mount
   560k sysinfo
   686k ls
   575k cp
   569k chown
   564k chmod
   565k rm
   570k rx
   578k login
   518k session
[/dev/tty0]:/# ps
OWNER    PID  FATH  CORE  STATE     PROC
kernel   0    -1    0:0%  blk[0]    /sbin/init
kernel   5    0     0:0%  run       /sbin/core
kernel   6    0     0:0%  blk[6]    /sbin/vfsd
kernel   7    0     0:10% blk[7]    /sbin/sdfsd
root     10   0     2:0%  rdy       /drivers/raspix/uartd
root     12   0     1:0%  slp       /drivers/timerd
root     14   0     1:0%  blk[14]   /drivers/ramfsd
root     16   0     3:0%  blk[16]   /drivers/nulld
root     18   0     2:0%  blk[18]   /sbin/sessiond
root     20   0     3:0%  wat[22]   /bin/session
root     22   20    3:0%  wat[26]   /bin/shell
root     26   22    1:11% run       /bin/ps

task_num: 12, memory: total 1024 MB, free 842 MB, shm 0 MB
cpu idle:  86%  88%  99%  99%
[/dev/tty0]:/# sysinfo
machine            raspberry-pi3b
arch               aarch64
cores              4
kmalloc free       5/8 MB
phy mem size       1024 MB
usable mem size    1024 MB
free mem           842 MB
sys_dma_base       phy:0x01cf5000, V:0xf0000000 (16384 KB)
mmio_base          Phy:0x3f000000, V:0xe8000000 (31 MB)
framebuffer_base   Phy:0x00000000, V:0xf1000000 (64 MB)
[/dev/tty0]:/# svcinfo
SVC  TIMES      %  TYPE
----------------------------------
0    0         0%  none
1    7         0%  kprintf
2    3147      1%  malloc_expand
3    0         0%  malloc_size
4    0         0%  free
5    25        0%  exec_elf
6    24        0%  fork
7    0         0%  thread
8    0         0%  yield
9    15        0%  wait_pid
10   139567   77%  usleep
11   13        0%  exit
12   12        0%  detach
13   73        0%  block
14   116       0%  wakeup
15   30        0%  signal_setup
16   0         0%  signal
17   0         0%  signal_end
18   54        0%  get_pid
19   0         0%  get_threadid
20   50        0%  ipc_ping
21   8         0%  ipc_ready
22   30        0%  get_cmd
23   1         0%  set_cmd
24   23        0%  get_uid
25   2         0%  set_uid
26   1339      0%  shm_alloc
27   2678      1%  shm_map
28   2678      1%  shm_unmap
29   27        0%  get_sys_info
30   3         0%  get_sys_state
31   30        0%  get_vsyscall_info
32   258       0%  get_proc
33   1         0%  get_procs_num
34   1         0%  get_procs
35   9         0%  mem_map
36   0         0%  sys_v2p
37   0         0%  sys_p2v
38   8         0%  ipc_setup
39   3585      1%  ipc_call
40   3203      1%  ipc_get_arg
41   3080      1%  ipc_set_return
42   5632      3%  ipc_get_return
43   3203      1%  ipc_end
44   2974      1%  ipc_disable
45   2973      1%  ipc_enable
46   1         0%  core_ready
47   193       0%  core_pid
48   4355      2%  get_kevent
49   0         0%  intr_setup
50   0         0%  intr_end
51   0         0%  semaphore_alloc
52   0         0%  semaphore_free
53   0         0%  semaphore_enter
54   0         0%  semaphore_quit
55   0         0%  soft_int
56   10        0%  get_gid
57   2         0%  set_gid
58   20        0%  unknown
59   0         0%  unknown
60   20        0%  unknown
61   0         0%  unknown
62   0         0%  unknown
63   0         0%  unknown

total:  179480
[/dev/tty0]:/# QEMU: Terminated
ewokos/machine.3rd/raspix/kernel$ 
```